{% extends 'layout.html' %}

{% block body %}
<div class="container my-5">
    <div class="row justify-content-center ">
        <div class="col-md-8 ">
            <h1 class=" font-weight-light"> Bleep New Video </h1>
            <div class="card collapsed-card">
                <div class="card-header bg-theme-secondary text-theme-secondary">
                  <h3 class="card-title text-theme-secondary">How to:</h3>
  
                  <div class="card-tools">
                    <button type="button" class="btn btn-tool text-theme-secondary" data-card-widget="collapse"><i class="fa fa-plus"></i>
                    </button>
                  </div>
                </div>
                <div class="card-body">
                    <section>
                        <div class="container">
                            <div class=" text-center">
                                <h2>Remove profanities in your videos in just 3 steps!</h2>
                                <p>Just follow the following instructions:</p>
                            </div>
                            <div class="card-deck mt-3 container">
                                <div class="card">
                                    <div class="card-header text-center bg-dark text-white">
                                        <h4 class="card-title">Step 1</h4>
                                    </div>
                                    <div class="card-body text-center">
                                        <i class="fa fa-upload fa-5x" aria-hidden="true"></i> <br>
                                        <p class="mt-3">Upload or choose video that you want to remove the profanity</p>
                                    </div>
                                </div>
                                <div class="card">
                                    <div class="card-header text-center bg-dark text-white">
                                        <h4 class="card-title">Step 2</h4>
                                    </div>
                                    <div class="card-body text-center">
                                        <i class="fa fa-spinner fa-5x" aria-hidden="true"></i>
                                        <p class="mt-3">Run Bleepy! Wait until your video done processing. You can also choose bleep sound before running</p>
                                    </div>
                                </div>
                                <div class="card">
                                    <div class="card-header text-center bg-dark text-white">
                                        <h4 class="card-title">Step 3</h4>
                                    </div>
                                    <div class="card-body text-center">
                                        <i class="fa fa-download fa-5x" aria-hidden="true"></i>
                                        <p class="mt-3">Download your videos</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </section>
                </div>
            </div>
            <div id="bleepstep1div">
                <div class="card card-tabs" id="bleepstep1card">
                    <div class="card-header p-0 pt-1 bg-theme-secondary text-theme-secondary">
                        <div class="card-tools">
                            <button type="button" class="btn btn-tool" data-card-widget="maximize">
                                <i class="fa fa-expand text-theme-secondary"></i>
                            </button>
                            <button type="button" class="btn btn-tool" data-card-widget="collapse">
                                <i class="fa fa-minus text-theme-secondary"></i>
                            </button>
                        </div>
                        <ul class="nav nav-tabs" id="custom-tabs-two-tab" role="tablist">
                            <li class="pt-2 px-3"><h3 class="card-title">Step 1:</h3></li>
                            <li class="nav-item">
                            <a class="nav-link active" id="step1-upload-video-tab" data-toggle="pill" href="#step1-upload-video" role="tab" aria-controls="custom-tabs-two-home" aria-selected="true">Upload Video</a>
                            </li>
                            <li class="nav-item">
                            <a class="nav-link" id="step1-choose-video-tab" data-toggle="pill" href="#step1-choose-video" role="tab" aria-controls="custom-tabs-two-profile" aria-selected="false">Choose Video</a>
                            </li>
                        </ul>
                    </div>
                    <div class="card-body">
                        <div class="tab-content" id="custom-tabs-two-tabContent">
                            <div class="tab-pane fade show active" id="step1-upload-video" role="tabpanel" aria-labelledby="step1-upload-video-tab">
                                <h3 class=" font-weight-light">Upload new video</h3>
                                <span class="text-danger"id="cancelUploadMsg"></span>
                                <form action="/bleepstep1" id="uploadVideoForm" method="POST" enctype="multipart/form-data">
                                    <div class="custom-file mb-3">
                                    <input type="file" class="custom-file-input" id="uploadFile" name="uploadFile" accept="video/mp4, video/mkv">
                                    <label class="custom-file-label" for="uploadFile">Choose file</label>
                                    </div>
                                    <div class="form-group" id="uploadSubmitDiv" style="display: none;">
                                        <input type="submit" id="uploadSubmit" value="Upload" class="btn btn-info" />
                                    </div>
                                    <div class="form-group" id="cancelSubmitDiv" style="display: none;">
                                        <button class="btn btn-info" disabled id="loader-icon">
                                            <span class="spinner-border spinner-border-sm"></span>
                                            Loading..
                                        </button>
                                        <input type="button" id="cancelSubmit" value="Cancel" class="btn btn-danger" />
                                    </div>
                                    
                                    <div class="progress" id="uploadProgress" style="display: none;">
                                        <div class="progress-bar progress-bar-striped bg-success progress-bar-animated" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width: 50%;">50%</div>
                                    </div>
                                    <div id="targetLayer" style="display:none;" class="mt-3">
                    
                                    </div>
                                </form>
                            </div>
                            <div class="tab-pane fade" id="step1-choose-video" role="tabpanel" aria-labelledby="step1-choose-video-tab">
                                <h3 class=" font-weight-light">Choose from your videos</h3>
                                {% if viewdata.get("videos") %}
                                <form action="" id="chooseVideoForm">
                                    <div class="input-group mb-3">
                                        <select name="chooseVideo" class="custom-select" id="chooseVideo">
                                        <option selected value="">Choose video</option>
                                        {% for videoinfo in viewdata.get("videos") %}
                                        <option value="{{videoinfo.get('video_id')}}">{{videoinfo.get("filename")}}</option>
                                        {% endfor %}
                                        </select>
                                    </div>

                                    <div class="embed-responsive embed-responsive-16by9 mb-3" id="choosevideopreviewdiv">
                                        <video class="embed-responsive-item" controls id="choosevideopreview">
                                            <source src="" type="video/mp4" />
                                            This video is not supported by your browser...
                                        </video>
                                    </div>

                                    <div class="form-group" id="chooseSubmitDiv" style="display: none;">
                                        <input type="submit" id="chooseSubmit" value="Choose" class="btn btn-info" />
                                    </div>

                                    <div id="choosevideomsgdiv">

                                    </div>
                                </form>
                                {% else %}
                                <div class="jumbotron bg-white text-theme text-center shadow">
                                    <h3> You have no uploaded videos </h3>
                                    <a href="/bleepvideo?step1=step1-upload-video">
                                        <button type="button" class="btn btn-theme"> Upload Videos </button>
                                    </a>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    <!-- /.card -->
                </div>
            </div>

            <div id="bleepstep2div" style="display: none;">
                                     
            </div>

            <div id="bleepstep3div" style="display: none;">
                
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block script %}
<script>
    // Add the following code if you want the name of the file appear on select
    loadStep1(getParameter("step1"))
    function loadStep1(step1){
        if (step1 == "step1-choose-video") {
            $('.nav-tabs a[href="#step1-choose-video"]').tab('show')
        }else{
            $('.nav-tabs a[href="#step1-upload-video"]').tab('show')
        }
    }
    function getParameter(p){
        var url = window.location.search.substring(1);
        var varUrl = url.split('&');
        for (var i = 0; i < varUrl.length; i++){
            var parameter = varUrl[i].split('=');
            if (parameter[0] == p){
                return parameter[1];
            }
        }
    }
    

    $(".custom-file-input").on("change", function() {
        var fileName = $(this).val().split("\\").pop();
        $(this).siblings(".custom-file-label").addClass("selected").html(fileName == "" ? "Choose file":fileName);
    });

    $('#uploadSubmitDiv').hide();
    $('#uploadFile').on('change', function() {
        $('#uploadSubmitDiv').hide();
        $('#uploadProgress').hide();
        $('#cancelUploadMsg').html("");
        if($('#uploadFile').val()){
            document.cookie = `filesize= ${this.files[0].size}`;
            console.log(`filesize= ${this.files[0].size}`)
            $('#uploadSubmitDiv').show();
        }
    });

    $('#uploadVideoForm').submit(function(event){
        if($('#uploadFile').val()){
            event.preventDefault();
            $('.progress-bar').removeClass("bg-danger");
            $('.progress-bar').addClass("bg-primary");
            $('#uploadFile').hide();
            $('#uploadSubmitDiv').hide();
            $('#cancelSubmitDiv').show();
            $('#uploadProgress').show();
            $('#loader-icon').show();
            $('#cancelUploadMsg').html("");
            //FROM THIS USES JQUERY FORM
            $('#targetLayer').hide();
            $('#targetLayer').hide();
            var form = $(this).ajaxSubmit({
                target: '#targetLayer',
                beforeSubmit:function(){
                    $('.progress-bar').width('0%')
                },
                uploadProgress: function(event, position, total, percentageComplete){
                    $('.progress-bar').width(percentageComplete+ '%');
                    $('.progress-bar').html(percentageComplete+ '%');
                    $('#uploadSubmitDiv').hide();
                },
                success:function(data){
                    $('#loader-icon').hide();
                    $('#targetLayer').show();
                    $('#cancelSubmitDiv').hide();
                    $('#uploadFile').show();
                    //$('#uploadFile').prop('disabled', false);
                    $('#targetLayer').html(data.responsemsg);
                    if(data.bleepstep1response){
                        $('#bleepstep1card').CardWidget('collapse')
                        $('#bleepstep1card').CardWidget('minimize')
                        $('#bleepstep2div').show();
                        $('#bleepstep2div').html(data.bleepstep1response);
                    }
                },
                resetForm: true
            })
            xhr = form.data('jqxhr');
            //To this

        }
        return false;
    });

    $("#cancelSubmit").click(function(){
            xhr.abort();
            $('#loader-icon').hide();
            $('#cancelUploadMsg').html("Cancelled");
            $('.progress-bar').removeClass("bg-primary");
            $('.progress-bar').addClass("bg-danger");
            $('#cancelSubmitDiv').hide();
            $('#uploadFile').show();
    });

    ////

    $('#chooseSubmitDiv').hide();
    $('#chooseVideo').on('change', function() {
        $('#chooseSubmitDiv').hide();
        if($('#chooseVideo').val()){
            $('#chooseSubmitDiv').show();
        }
    });

    $('#choosevideopreviewdiv').hide();
    $('#chooseVideo').on('change', function() {
        $('#choosevideopreviewdiv').hide();
        if($('#chooseVideo').val()){
            $.ajax ({
                type:"POST",
                url:"/getvideoinfo",
                data: {
                    vid_id:$('#chooseVideo').val()
                },
                cache: false,
                success:function(data){
                    
                    $('#choosevideopreviewdiv').show();
                    $('#choosevideopreview source').attr('src',data.filelocation);
                    $("#choosevideopreview ")[0].load();
                    
                },error:function(e){
                    alert("error: "+e)
                }
            });
        }
        else{
            //Stops video 
            $('#choosevideopreview source').attr('src', $('#chooseVideo').val());
            $("#choosevideopreview ")[0].load();
        }
    });

    
    $('#chooseVideoForm').submit(function(event){
        if($('#chooseVideo').val()){
            event.preventDefault();
            $.ajax ({
                type:"POST",
                url:"/bleepstep1",
                data: {
                    vid_id:$('#chooseVideo').val(),
                    choosevideo:true
                },
                cache: false,
                success:function(data){
                    $('#bleepstep1card').CardWidget('collapse')
                    $('#bleepstep1card').CardWidget('minimize')
                    $('#bleepstep2div').show();
                    $('#bleepstep2div').html(data.bleepstep1response);
                    $('#choosevideomsgdiv').html(data.responsemsg);
                },error:function(e){
                    alert("error: "+e)
                }
            });

        }
    });

</script>
{% endblock %}